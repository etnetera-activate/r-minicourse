---
title       : Data v R
subtitle    : principy, čtení, zápis
author      : Jiri Stepan (jiri.stepan@etnetera.cz)
job         : Etnetera Activate
framework   : io2012        # {io2012, html5slides, shower, dzslides, ...}
highlighter : highlight.js  # {highlight.js, prettify, highlight}
hitheme     : tomorrow      # 
widgets     : []            # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone, draft}

```{r setup, include=FALSE}
# set global chunk options
opts_chunk$set(cache=FALSE)
library(reshape)
library(plyr)
set.seed(1977)
```

---

Fáze získání a čištění dat
--------------------------

Trvá většinou 80% času. Jejím cílem je získat čistá data pro následnou analýzu. Zahrnuje:
* samotné načtění dat z nějakého zdroje
* specifikace typů
* řešení chybějících dat a outlierů
* přejmenovávání a organizace proměných
* převod to tidy formátu

Celý proces musí být perfekně popsán a musí být opakovatelný!

---

Základní forma dat - tidy data
------------------------------

Abychom mohli data zpracovávavat v R, musíme je z RAW data dostat do formátu zvaného *Tidy data*. Což znamená.

* každý soubor obsahuje pozorování jednoho typu
* každý sloupen odpovídá jedné proměné a každá proměná je právě v jednom sloupci.
* každá řádka obsahuje hodnoty proměných pro jedno pozorování nebo `missing`

---

Toto nejsou tidy data
---------------------
Předpokládejme, že děláme AB test a vyhodnocujeme jej. Nagenerujeme si data pro sedm dnů.

```{r}
n<-7
data<-as.data.frame(
  list(
    date=seq(as.Date("2012-01-01"),as.Date("2012-01-01")+n-1,by="1 day"),
    visitsA=as.integer(rnorm(n=n,mean=1000,sd=50)),
    convA=rbinom(n=n,size=1000,prob=0.01),
    visitsB=as.integer(rnorm(n=n,mean=1000,sd=50)),
    convB=rbinom(n=n,size=1000,prob=0.02)
    )
  )

data
```

---

Toto jsou spravna data
----------------------
Abychom je ziskali, musime si je trochu upravit.

```{r}
tmpA <- melt(data=data[,c(1,2,3)],id=c("date","visitsA"))
tmpB <- melt(data=data[,c(1,4,5)],id=c("date","visitsB"))
tmpA<-rename(tmpA,c("visitsA"="visits","variable"="testgroup","value"="conversions"))
tmpB<-rename(tmpB,c("visitsB"="visits","variable"="testgroup","value"="conversions"))
data.tidy<-rbind(tmpA,tmpB)
head(data.tidy)
```

---
Takovýmto datům totiž Rko rozumí a počítá s nimi na vstupy

```{r fig.height=5,fig.width=10}
par(mfcol=c(1,2))
boxplot(data.tidy$conversions ~ data.tidy$testgroup)
plot(x=data.tidy$visits,y=data.tidy$conversions,pch=19,col=as.numeric(data.tidy$testgroup))
```


---

A pro změnu agregace
--------------------
Abychom ale mohli udělat ověření AB testu musíme je agregovat, protože mne nezajímají datumy, ale celý soubor pro A, resp B.

```{r}
library(plyr)
data.aggregated <- ddply(data.tidy,.(testgroup),summarize, visits=sum(visits),conversions=sum(conversions))
data.aggregated
```

---

A finalni test, zda B je opravdu lepsi

```{r}
test<-prop.test(x=data.aggregated$conversions,n=data.aggregated$visits,alternative="two.sided")
print(test)
```

----

Pro zajimavost 
--------------
Toto je typicka struktura, ktera je vystupem statistickych funkci a modelu.

```{r}
str(test)
```

.. ale zpět k datům

---

Import dat
----------
Nejčastější příklady:

* Libovolný soubor z disku nebo dostupný na internetu
* CSV pomocí `read.csv()`
* XML pomocí package `XML`
* JSON pomocí package `bjson`
* Google anlaytics pomocí package `rga`

---

Pracovní data
-------------

Interní objekty lze ukládat a nahrávat pomocí `load()` a `save()` do interní binární formy. Typicky slouží pro uložení vyčištěných a transformovaných dat.

```{r}
save(data.tidy, data.aggregated, file="mydata.rda")
rm(list=ls()) #delete all objects
dim(data.tidy)
```

```{r}
load(file="mydata.rda")
dim(data.tidy)
```

---
Komplexnější příklad číštění dat
--------------------------------

Zkusíme si udělat analýzu rozvodovosti dle dat poskytovaných ČSÚ.

---

Další zajímavé packages
-----------------------

* `httr` - for working with http connections
* `RMySQL` - for interfacing with mySQL
* `RMogo` - acesing mongo
* `bigmemory` - for handling data larger than RAM
* `RHadoop` - for interfacing R and Hadoop (by Revolution Analytics)
* `foreign` - for getting data into R from SAS, SPSS, Octave, etc.
* `rJava` - accesing java objects
* ...
